<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SlowMA - Slow Looking Art</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <canvas id="constellationCanvas" class="constellation-canvas"></canvas>
    
    <div class="container">
        <header>
            <h1>SlowMA</h1>
            <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
        </header>
        
        <div id="menu" class="menu hidden">
            <a href="/profile">Profile</a>
            <a href="/gallery">Gallery</a>
            {% if authenticated %}
            <a href="#" onclick="signOut(); return false;">Sign Out</a>
            {% else %}
            <a href="/signin">Sign In</a>
            {% endif %}
        </div>
        
        <div class="hero">
            <h2>Slow down. Observe. Connect.</h2>
            <p>A lifelong companion to establish and develop a relationship with art.</p>
        </div>
        
        <div class="card">
            <h3>Start Your Journey</h3>
            
            <input type="file" id="artwork-input" accept="image/*" style="display: none;">
            <button class="btn-primary" onclick="document.getElementById('artwork-input').click()">
                üñºÔ∏è Upload Artwork Photo
            </button>
            
            <div id="preview" class="preview hidden">
                <img id="preview-img" alt="Preview">
            </div>
            
            <div id="loading" class="loading hidden">
                <div class="spinner"></div>
                <p>Analyzing your artwork...</p>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number">{{ user.journeys_completed or 0 }}</div>
                <div class="stat-label">Journeys</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ (user.total_time_seconds or 0) // 60 }}</div>
                <div class="stat-label">Minutes</div>
            </div>
        </div>
        
        {% if notifications %}
        <div class="notifications">
            {% for notification in notifications %}
            <div class="notification {{ notification.type }}">
                {{ notification.message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <script src="{{ url_for('static', filename='app.js') }}?v=2"></script>
    <script src="{{ url_for('static', filename='constellation.js') }}?v=6"></script>
    <script>
        var constellationData = {{ constellation_data | tojson | safe }};
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, constellation data:', constellationData);
            if (typeof initConstellation === 'function') {
                initConstellation(constellationData);
            }
        });
        
        function signOut() {
            fetch('/auth/signout', {method: 'POST'})
                .then(function(r) { if (r.ok) window.location.href = '/signin'; });
        }
        
        document.getElementById('artwork-input').addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(evt) {
                document.getElementById('preview-img').src = evt.target.result;
                document.getElementById('preview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
            
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('preview').classList.add('hidden');
            
            var formData = new FormData();
            formData.append('artwork', file);
            formData.append('at_museum', false);
            
            fetch('/upload', {method: 'POST', body: formData})
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    if (!d.success) throw new Error(d.error);
                    return fetch('/analyze', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({filepath: d.filepath, at_museum: d.at_museum})
                    });
                })
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    if (!d.success) throw new Error(d.error);
                    window.location.href = '/walkthrough/' + d.journey_id;
                })
                .catch(function(err) {
                    alert('Error: ' + err.message);
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('preview').classList.remove('hidden');
                });
        });
    </script>
</body>
</html>